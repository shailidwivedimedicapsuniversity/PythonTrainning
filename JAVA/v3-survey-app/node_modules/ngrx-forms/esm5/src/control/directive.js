import * as tslib_1 from "tslib";
import { DOCUMENT } from '@angular/common';
import { Directive, ElementRef, HostBinding, HostListener, Inject, Input, Optional, Self, } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { ActionsSubject } from '@ngrx/store';
import { FocusAction, MarkAsDirtyAction, MarkAsTouchedAction, SetValueAction, UnfocusAction } from '../actions';
import { selectViewAdapter } from '../view-adapter/util';
import { NGRX_FORM_VIEW_ADAPTER } from '../view-adapter/view-adapter';
import { NgrxValueConverters } from './value-converter';
export var NGRX_UPDATE_ON_TYPE;
(function (NGRX_UPDATE_ON_TYPE) {
    NGRX_UPDATE_ON_TYPE["CHANGE"] = "change";
    NGRX_UPDATE_ON_TYPE["BLUR"] = "blur";
    NGRX_UPDATE_ON_TYPE["NEVER"] = "never";
})(NGRX_UPDATE_ON_TYPE || (NGRX_UPDATE_ON_TYPE = {}));
var ControlValueAccessorAdapter = /** @class */ (function () {
    function ControlValueAccessorAdapter(valueAccessor) {
        this.valueAccessor = valueAccessor;
    }
    ControlValueAccessorAdapter.prototype.setViewValue = function (value) {
        this.valueAccessor.writeValue(value);
    };
    ControlValueAccessorAdapter.prototype.setOnChangeCallback = function (fn) {
        this.valueAccessor.registerOnChange(fn);
    };
    ControlValueAccessorAdapter.prototype.setOnTouchedCallback = function (fn) {
        this.valueAccessor.registerOnTouched(fn);
    };
    ControlValueAccessorAdapter.prototype.setIsDisabled = function (isDisabled) {
        if (this.valueAccessor.setDisabledState) {
            this.valueAccessor.setDisabledState(isDisabled);
        }
    };
    return ControlValueAccessorAdapter;
}());
var NgrxFormControlDirective = /** @class */ (function () {
    function NgrxFormControlDirective(el, 
    // for the dom parameter the `null` type must be last to ensure that in the compiled output
    // there is no reference to the Document type to support non-browser platforms
    dom, actionsSubject, viewAdapters, valueAccessors) {
        this.el = el;
        this.dom = dom;
        this.actionsSubject = actionsSubject;
        this.isInitialized = false;
        this.focusTrackingIsEnabled = false;
        this.ngrxUpdateOn = NGRX_UPDATE_ON_TYPE.CHANGE;
        this.ngrxValueConverter = NgrxValueConverters.default();
        viewAdapters = viewAdapters || [];
        valueAccessors = valueAccessors || [];
        if (valueAccessors.length > 1) {
            throw new Error('More than one custom control value accessor matches!');
        }
        this.viewAdapter = valueAccessors.length > 0
            ? new ControlValueAccessorAdapter(valueAccessors[0])
            : selectViewAdapter(viewAdapters);
    }
    Object.defineProperty(NgrxFormControlDirective.prototype, "ngrxFormControlState", {
        set: function (newState) {
            if (!newState) {
                throw new Error('The control state must not be undefined!');
            }
            var oldState = this.state;
            this.state = newState;
            if (this.isInitialized) {
                this.updateViewIfControlIdChanged(newState, oldState);
                this.updateViewIfValueChanged(newState, oldState);
                this.updateViewIfIsDisabledChanged(newState, oldState);
                this.updateViewIfIsFocusedChanged(newState, oldState);
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgrxFormControlDirective.prototype, "ngrxEnableFocusTracking", {
        set: function (value) {
            if (value && !this.dom) {
                throw new Error('focus tracking is only supported on the browser platform');
            }
            this.focusTrackingIsEnabled = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgrxFormControlDirective.prototype, "focusRegionStartAttr", {
        // TODO: move this into a separate directive
        // automatically apply the attribute that's used by the CDK to set initial focus
        get: function () {
            return this.state && this.state.isFocused ? '' : null;
        },
        enumerable: true,
        configurable: true
    });
    NgrxFormControlDirective.prototype.updateViewIfControlIdChanged = function (newState, oldState) {
        if (oldState && newState.id === oldState.id) {
            return;
        }
        this.stateValue = newState.value;
        this.viewValue = this.ngrxValueConverter.convertStateToViewValue(this.stateValue);
        this.viewAdapter.setViewValue(this.viewValue);
        if (this.viewAdapter.setIsDisabled) {
            this.viewAdapter.setIsDisabled(newState.isDisabled);
        }
    };
    NgrxFormControlDirective.prototype.updateViewIfValueChanged = function (newState, _) {
        if (newState.value === this.stateValue) {
            return;
        }
        this.stateValue = newState.value;
        this.viewValue = this.ngrxValueConverter.convertStateToViewValue(newState.value);
        this.viewAdapter.setViewValue(this.viewValue);
    };
    NgrxFormControlDirective.prototype.updateViewIfIsDisabledChanged = function (newState, oldState) {
        if (!this.viewAdapter.setIsDisabled) {
            return;
        }
        if (oldState && newState.isDisabled === oldState.isDisabled) {
            return;
        }
        this.viewAdapter.setIsDisabled(newState.isDisabled);
    };
    NgrxFormControlDirective.prototype.updateViewIfIsFocusedChanged = function (newState, oldState) {
        if (!this.focusTrackingIsEnabled) {
            return;
        }
        if (oldState && newState.isFocused === oldState.isFocused) {
            return;
        }
        if (newState.isFocused) {
            this.el.nativeElement.focus();
        }
        else {
            this.el.nativeElement.blur();
        }
    };
    NgrxFormControlDirective.prototype.dispatchAction = function (action) {
        if (this.actionsSubject !== null) {
            this.actionsSubject.next(action);
        }
        else {
            throw new Error('ActionsSubject must be present in order to dispatch actions!');
        }
    };
    NgrxFormControlDirective.prototype.ngOnInit = function () {
        var _this = this;
        if (!this.state) {
            throw new Error('The form state must not be undefined!');
        }
        this.isInitialized = true;
        this.updateViewIfControlIdChanged(this.state, undefined);
        this.updateViewIfValueChanged(this.state, undefined);
        this.updateViewIfIsDisabledChanged(this.state, undefined);
        this.updateViewIfIsFocusedChanged(this.state, undefined);
        var dispatchMarkAsDirtyAction = function () {
            if (_this.state.isPristine) {
                _this.dispatchAction(new MarkAsDirtyAction(_this.state.id));
            }
        };
        var dispatchSetValueAction = function () {
            _this.stateValue = _this.ngrxValueConverter.convertViewToStateValue(_this.viewValue);
            if (_this.stateValue !== _this.state.value) {
                _this.dispatchAction(new SetValueAction(_this.state.id, _this.stateValue));
                dispatchMarkAsDirtyAction();
            }
        };
        this.viewAdapter.setOnChangeCallback(function (viewValue) {
            _this.viewValue = viewValue;
            if (_this.ngrxUpdateOn === NGRX_UPDATE_ON_TYPE.CHANGE) {
                dispatchSetValueAction();
            }
        });
        this.viewAdapter.setOnTouchedCallback(function () {
            if (!_this.state.isTouched && _this.ngrxUpdateOn !== NGRX_UPDATE_ON_TYPE.NEVER) {
                _this.dispatchAction(new MarkAsTouchedAction(_this.state.id));
            }
            if (_this.ngrxUpdateOn === NGRX_UPDATE_ON_TYPE.BLUR) {
                dispatchSetValueAction();
            }
        });
    };
    NgrxFormControlDirective.prototype.ngAfterViewInit = function () {
        // we need to update the view again after it was initialized since some
        // controls depend on child elements for setting the value (e.g. selects)
        this.viewAdapter.setViewValue(this.viewValue);
        if (this.viewAdapter.setIsDisabled) {
            this.viewAdapter.setIsDisabled(this.state.isDisabled);
        }
    };
    NgrxFormControlDirective.prototype.onFocusChange = function () {
        if (!this.focusTrackingIsEnabled) {
            return;
        }
        var isControlFocused = this.el.nativeElement === this.dom.activeElement;
        if (isControlFocused !== this.state.isFocused) {
            this.dispatchAction(isControlFocused ? new FocusAction(this.state.id) : new UnfocusAction(this.state.id));
        }
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], NgrxFormControlDirective.prototype, "ngrxFormControlState", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], NgrxFormControlDirective.prototype, "ngrxUpdateOn", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean),
        tslib_1.__metadata("design:paramtypes", [Boolean])
    ], NgrxFormControlDirective.prototype, "ngrxEnableFocusTracking", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgrxFormControlDirective.prototype, "ngrxValueConverter", void 0);
    tslib_1.__decorate([
        HostBinding('attr.cdk-focus-region-start'),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [])
    ], NgrxFormControlDirective.prototype, "focusRegionStartAttr", null);
    tslib_1.__decorate([
        HostListener('focusin'),
        HostListener('focusout'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], NgrxFormControlDirective.prototype, "onFocusChange", null);
    NgrxFormControlDirective = tslib_1.__decorate([
        Directive({
            // tslint:disable-next-line:directive-selector
            selector: ':not([ngrxFormsAction])[ngrxFormControlState]',
        }),
        tslib_1.__param(1, Optional()), tslib_1.__param(1, Inject(DOCUMENT)),
        tslib_1.__param(2, Optional()), tslib_1.__param(2, Inject(ActionsSubject)),
        tslib_1.__param(3, Self()), tslib_1.__param(3, Optional()), tslib_1.__param(3, Inject(NGRX_FORM_VIEW_ADAPTER)),
        tslib_1.__param(4, Self()), tslib_1.__param(4, Optional()), tslib_1.__param(4, Inject(NG_VALUE_ACCESSOR)),
        tslib_1.__metadata("design:paramtypes", [ElementRef, Object, Object, Array, Array])
    ], NgrxFormControlDirective);
    return NgrxFormControlDirective;
}());
export { NgrxFormControlDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmdyeC1mb3Jtcy8iLCJzb3VyY2VzIjpbInNyYy9jb250cm9sL2RpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFdBQVcsRUFDWCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFFTCxRQUFRLEVBQ1IsSUFBSSxHQUNMLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBd0IsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBVyxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsbUJBQW1CLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUV6SCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN6RCxPQUFPLEVBQW1CLHNCQUFzQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDdkYsT0FBTyxFQUFzQixtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBTTVFLE1BQU0sQ0FBTixJQUFZLG1CQUlYO0FBSkQsV0FBWSxtQkFBbUI7SUFDN0Isd0NBQWlCLENBQUE7SUFDakIsb0NBQWEsQ0FBQTtJQUNiLHNDQUFlLENBQUE7QUFDakIsQ0FBQyxFQUpXLG1CQUFtQixLQUFuQixtQkFBbUIsUUFJOUI7QUFFRDtJQUNFLHFDQUFvQixhQUFtQztRQUFuQyxrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7SUFBSSxDQUFDO0lBRTVELGtEQUFZLEdBQVosVUFBYSxLQUFVO1FBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCx5REFBbUIsR0FBbkIsVUFB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RVE7UUFBUixLQUFLLEVBQUU7O3dFQUFzRztJQUlsRTtRQUEzQyxXQUFXLENBQUMsNkJBQTZCLENBQUM7Ozt3RUFFMUM7SUEwSkQ7UUFGQyxZQUFZLENBQUMsU0FBUyxDQUFDO1FBQ3ZCLFlBQVksQ0FBQyxVQUFVLENBQUM7Ozs7aUVBVXhCO0lBdE1VLHdCQUF3QjtRQUpwQyxTQUFTLENBQUM7WUFDVCw4Q0FBOEM7WUFDOUMsUUFBUSxFQUFFLCtDQUErQztTQUMxRCxDQUFDO1FBeURHLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQzVCLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBQ2xDLG1CQUFBLElBQUksRUFBRSxDQUFBLEVBQUUsbUJBQUEsUUFBUSxFQUFFLENBQUEsRUFBRSxtQkFBQSxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtRQUNsRCxtQkFBQSxJQUFJLEVBQUUsQ0FBQSxFQUFFLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7aURBTmxDLFVBQVU7T0FyRGIsd0JBQXdCLENBdU1wQztJQUFELCtCQUFDO0NBQUEsQUF2TUQsSUF1TUM7U0F2TVksd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQge1xyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgRGlyZWN0aXZlLFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgSG9zdEJpbmRpbmcsXHJcbiAgSG9zdExpc3RlbmVyLFxyXG4gIEluamVjdCxcclxuICBJbnB1dCxcclxuICBPbkluaXQsXHJcbiAgT3B0aW9uYWwsXHJcbiAgU2VsZixcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBBY3Rpb25zU3ViamVjdCB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcclxuXHJcbmltcG9ydCB7IEFjdGlvbnMsIEZvY3VzQWN0aW9uLCBNYXJrQXNEaXJ0eUFjdGlvbiwgTWFya0FzVG91Y2hlZEFjdGlvbiwgU2V0VmFsdWVBY3Rpb24sIFVuZm9jdXNBY3Rpb24gfSBmcm9tICcuLi9hY3Rpb25zJztcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2xTdGF0ZSwgRm9ybUNvbnRyb2xWYWx1ZVR5cGVzIH0gZnJvbSAnLi4vc3RhdGUnO1xyXG5pbXBvcnQgeyBzZWxlY3RWaWV3QWRhcHRlciB9IGZyb20gJy4uL3ZpZXctYWRhcHRlci91dGlsJztcclxuaW1wb3J0IHsgRm9ybVZpZXdBZGFwdGVyLCBOR1JYX0ZPUk1fVklFV19BREFQVEVSIH0gZnJvbSAnLi4vdmlldy1hZGFwdGVyL3ZpZXctYWRhcHRlcic7XHJcbmltcG9ydCB7IE5ncnhWYWx1ZUNvbnZlcnRlciwgTmdyeFZhbHVlQ29udmVydGVycyB9IGZyb20gJy4vdmFsdWUtY29udmVydGVyJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRG9jdW1lbnQge1xyXG4gIGFjdGl2ZUVsZW1lbnQ6IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGVudW0gTkdSWF9VUERBVEVfT05fVFlQRSB7XHJcbiAgQ0hBTkdFID0gJ2NoYW5nZScsXHJcbiAgQkxVUiA9ICdibHVyJyxcclxuICBORVZFUiA9ICduZXZlcicsXHJcbn1cclxuXHJcbmNsYXNzIENvbnRyb2xWYWx1ZUFjY2Vzc29yQWRhcHRlciBpbXBsZW1lbnRzIEZvcm1WaWV3QWRhcHRlciB7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2YWx1ZUFjY2Vzc29yOiBDb250cm9sVmFsdWVBY2Nlc3NvcikgeyB9XHJcblxyXG4gIHNldFZpZXdWYWx1ZSh2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICB0aGlzLnZhbHVlQWNjZXNzb3Iud3JpdGVWYWx1ZSh2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBzZXRPbkNoYW5nZUNhbGxiYWNrKGZuOiAodmFsdWU6IGFueSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy52YWx1ZUFjY2Vzc29yLnJlZ2lzdGVyT25DaGFuZ2UoZm4pO1xyXG4gIH1cclxuICBzZXRPblRvdWNoZWRDYWxsYmFjayhmbjogKCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy52YWx1ZUFjY2Vzc29yLnJlZ2lzdGVyT25Ub3VjaGVkKGZuKTtcclxuICB9XHJcblxyXG4gIHNldElzRGlzYWJsZWQoaXNEaXNhYmxlZDogYm9vbGVhbikge1xyXG4gICAgaWYgKHRoaXMudmFsdWVBY2Nlc3Nvci5zZXREaXNhYmxlZFN0YXRlKSB7XHJcbiAgICAgIHRoaXMudmFsdWVBY2Nlc3Nvci5zZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmRpcmVjdGl2ZS1zZWxlY3RvclxyXG4gIHNlbGVjdG9yOiAnOm5vdChbbmdyeEZvcm1zQWN0aW9uXSlbbmdyeEZvcm1Db250cm9sU3RhdGVdJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIE5ncnhGb3JtQ29udHJvbERpcmVjdGl2ZTxUU3RhdGVWYWx1ZSBleHRlbmRzIEZvcm1Db250cm9sVmFsdWVUeXBlcywgVFZpZXdWYWx1ZSA9IFRTdGF0ZVZhbHVlPiBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uSW5pdCB7XHJcbiAgcHJpdmF0ZSBpc0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgcHJpdmF0ZSBmb2N1c1RyYWNraW5nSXNFbmFibGVkID0gZmFsc2U7XHJcblxyXG4gIEBJbnB1dCgpIHNldCBuZ3J4Rm9ybUNvbnRyb2xTdGF0ZShuZXdTdGF0ZTogRm9ybUNvbnRyb2xTdGF0ZTxUU3RhdGVWYWx1ZT4pIHtcclxuICAgIGlmICghbmV3U3RhdGUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgY29udHJvbCBzdGF0ZSBtdXN0IG5vdCBiZSB1bmRlZmluZWQhJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgb2xkU3RhdGUgPSB0aGlzLnN0YXRlO1xyXG4gICAgdGhpcy5zdGF0ZSA9IG5ld1N0YXRlO1xyXG5cclxuICAgIGlmICh0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgdGhpcy51cGRhdGVWaWV3SWZDb250cm9sSWRDaGFuZ2VkKG5ld1N0YXRlLCBvbGRTdGF0ZSk7XHJcbiAgICAgIHRoaXMudXBkYXRlVmlld0lmVmFsdWVDaGFuZ2VkKG5ld1N0YXRlLCBvbGRTdGF0ZSk7XHJcbiAgICAgIHRoaXMudXBkYXRlVmlld0lmSXNEaXNhYmxlZENoYW5nZWQobmV3U3RhdGUsIG9sZFN0YXRlKTtcclxuICAgICAgdGhpcy51cGRhdGVWaWV3SWZJc0ZvY3VzZWRDaGFuZ2VkKG5ld1N0YXRlLCBvbGRTdGF0ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKSBuZ3J4VXBkYXRlT246IE5HUlhfVVBEQVRFX09OX1RZUEUgPSBOR1JYX1VQREFURV9PTl9UWVBFLkNIQU5HRTtcclxuICBASW5wdXQoKSBzZXQgbmdyeEVuYWJsZUZvY3VzVHJhY2tpbmcodmFsdWU6IGJvb2xlYW4pIHtcclxuICAgIGlmICh2YWx1ZSAmJiAhdGhpcy5kb20pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdmb2N1cyB0cmFja2luZyBpcyBvbmx5IHN1cHBvcnRlZCBvbiB0aGUgYnJvd3NlciBwbGF0Zm9ybScpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZm9jdXNUcmFja2luZ0lzRW5hYmxlZCA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KCkgbmdyeFZhbHVlQ29udmVydGVyOiBOZ3J4VmFsdWVDb252ZXJ0ZXI8VFZpZXdWYWx1ZSwgVFN0YXRlVmFsdWU+ID0gTmdyeFZhbHVlQ29udmVydGVycy5kZWZhdWx0PGFueT4oKTtcclxuXHJcbiAgLy8gVE9ETzogbW92ZSB0aGlzIGludG8gYSBzZXBhcmF0ZSBkaXJlY3RpdmVcclxuICAvLyBhdXRvbWF0aWNhbGx5IGFwcGx5IHRoZSBhdHRyaWJ1dGUgdGhhdCdzIHVzZWQgYnkgdGhlIENESyB0byBzZXQgaW5pdGlhbCBmb2N1c1xyXG4gIEBIb3N0QmluZGluZygnYXR0ci5jZGstZm9jdXMtcmVnaW9uLXN0YXJ0JykgZ2V0IGZvY3VzUmVnaW9uU3RhcnRBdHRyKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RhdGUgJiYgdGhpcy5zdGF0ZS5pc0ZvY3VzZWQgPyAnJyA6IG51bGw7XHJcbiAgfVxyXG5cclxuICBzdGF0ZTogRm9ybUNvbnRyb2xTdGF0ZTxUU3RhdGVWYWx1ZT47XHJcblxyXG4gIHByaXZhdGUgdmlld0FkYXB0ZXI6IEZvcm1WaWV3QWRhcHRlcjtcclxuXHJcbiAgLy8gd2UgaGF2ZSB0byBzdG9yZSB0aGUgbGF0ZXN0IGtub3duIHN0YXRlIHZhbHVlIHNpbmNlIG1vc3QgaW5wdXQgZWxlbWVudHMgZG9uJ3QgcGxheSBuaWNlbHkgd2l0aFxyXG4gIC8vIHNldHRpbmcgdGhlIHNhbWUgdmFsdWUgYWdhaW4gKGUuZy4gaW5wdXQgZWxlbWVudHMgbW92ZSB0aGUgY3Vyc29yIHRvIHRoZSBlbmQgb2YgdGhlIGlucHV0IHdoZW5cclxuICAvLyBhIG5ldyB2YWx1ZSBpcyBzZXQgd2hpY2ggbWVhbnMgd2hlbmV2ZXIgdGhlIHVzZXIgdHlwZXMgc29tZXRoaW5nIHRoZSBjdXJzb3IgaXMgZm9yY2VkIHRvIHRoZVxyXG4gIC8vIGVuZCBvZiB0aGUgaW5wdXQpIHdoaWNoIHdvdWxkIGZvciBleGFtcGxlIGhhcHBlbiBldmVyeSB0aW1lIGEgbmV3IHZhbHVlIGlzIHB1c2hlZCB0byB0aGUgc3RhdGVcclxuICAvLyBzaW5jZSB3aGVuIHRoZSBhY3Rpb24gdG8gdXBkYXRlIHRoZSBzdGF0ZSBpcyBkaXNwYXRjaGVkIGEgbmV3IHN0YXRlIHdpbGwgYmUgcmVjZWl2ZWQgaW5zaWRlXHJcbiAgLy8gdGhlIGRpcmVjdGl2ZSwgd2hpY2ggaW4gdHVybiB3b3VsZCB0cmlnZ2VyIGEgdmlldyB1cGRhdGU7IHRvIHByZXZlbnQgdGhpcyBiZWhhdmlvciB3ZSBjb21wYXJlXHJcbiAgLy8gdGhlIGxhdGVzdCBrbm93biBzdGF0ZSB2YWx1ZSB3aXRoIHRoZSB2YWx1ZSB0byBiZSBzZXQgYW5kIGZpbHRlciBvdXQgdGhvc2UgdmFsdWVzIHRoYXQgYXJlIGVxdWFsXHJcbiAgLy8gdG8gdGhlIGxhdGVzdCBrbm93biB2YWx1ZVxyXG4gIHByaXZhdGUgdmlld1ZhbHVlOiBUVmlld1ZhbHVlO1xyXG4gIHByaXZhdGUgc3RhdGVWYWx1ZTogVFN0YXRlVmFsdWU7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcclxuICAgIC8vIGZvciB0aGUgZG9tIHBhcmFtZXRlciB0aGUgYG51bGxgIHR5cGUgbXVzdCBiZSBsYXN0IHRvIGVuc3VyZSB0aGF0IGluIHRoZSBjb21waWxlZCBvdXRwdXRcclxuICAgIC8vIHRoZXJlIGlzIG5vIHJlZmVyZW5jZSB0byB0aGUgRG9jdW1lbnQgdHlwZSB0byBzdXBwb3J0IG5vbi1icm93c2VyIHBsYXRmb3Jtc1xyXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb206IERvY3VtZW50IHwgbnVsbCxcclxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoQWN0aW9uc1N1YmplY3QpIHByaXZhdGUgYWN0aW9uc1N1YmplY3Q6IEFjdGlvbnNTdWJqZWN0IHwgbnVsbCxcclxuICAgIEBTZWxmKCkgQE9wdGlvbmFsKCkgQEluamVjdChOR1JYX0ZPUk1fVklFV19BREFQVEVSKSB2aWV3QWRhcHRlcnM6IEZvcm1WaWV3QWRhcHRlcltdLFxyXG4gICAgQFNlbGYoKSBAT3B0aW9uYWwoKSBASW5qZWN0KE5HX1ZBTFVFX0FDQ0VTU09SKSB2YWx1ZUFjY2Vzc29yczogQ29udHJvbFZhbHVlQWNjZXNzb3JbXSxcclxuICApIHtcclxuICAgIHZpZXdBZGFwdGVycyA9IHZpZXdBZGFwdGVycyB8fCBbXTtcclxuICAgIHZhbHVlQWNjZXNzb3JzID0gdmFsdWVBY2Nlc3NvcnMgfHwgW107XHJcblxyXG4gICAgaWYgKHZhbHVlQWNjZXNzb3JzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNb3JlIHRoYW4gb25lIGN1c3RvbSBjb250cm9sIHZhbHVlIGFjY2Vzc29yIG1hdGNoZXMhJyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy52aWV3QWRhcHRlciA9IHZhbHVlQWNjZXNzb3JzLmxlbmd0aCA+IDBcclxuICAgICAgPyBuZXcgQ29udHJvbFZhbHVlQWNjZXNzb3JBZGFwdGVyKHZhbHVlQWNjZXNzb3JzWzBdKVxyXG4gICAgICA6IHNlbGVjdFZpZXdBZGFwdGVyKHZpZXdBZGFwdGVycyk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVWaWV3SWZDb250cm9sSWRDaGFuZ2VkKG5ld1N0YXRlOiBGb3JtQ29udHJvbFN0YXRlPFRTdGF0ZVZhbHVlPiwgb2xkU3RhdGU6IEZvcm1Db250cm9sU3RhdGU8VFN0YXRlVmFsdWU+IHwgdW5kZWZpbmVkKSB7XHJcbiAgICBpZiAob2xkU3RhdGUgJiYgbmV3U3RhdGUuaWQgPT09IG9sZFN0YXRlLmlkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnN0YXRlVmFsdWUgPSBuZXdTdGF0ZS52YWx1ZTtcclxuICAgIHRoaXMudmlld1ZhbHVlID0gdGhpcy5uZ3J4VmFsdWVDb252ZXJ0ZXIuY29udmVydFN0YXRlVG9WaWV3VmFsdWUodGhpcy5zdGF0ZVZhbHVlKTtcclxuICAgIHRoaXMudmlld0FkYXB0ZXIuc2V0Vmlld1ZhbHVlKHRoaXMudmlld1ZhbHVlKTtcclxuICAgIGlmICh0aGlzLnZpZXdBZGFwdGVyLnNldElzRGlzYWJsZWQpIHtcclxuICAgICAgdGhpcy52aWV3QWRhcHRlci5zZXRJc0Rpc2FibGVkKG5ld1N0YXRlLmlzRGlzYWJsZWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgdXBkYXRlVmlld0lmVmFsdWVDaGFuZ2VkKG5ld1N0YXRlOiBGb3JtQ29udHJvbFN0YXRlPFRTdGF0ZVZhbHVlPiwgXzogRm9ybUNvbnRyb2xTdGF0ZTxUU3RhdGVWYWx1ZT4gfCB1bmRlZmluZWQpIHtcclxuICAgIGlmIChuZXdTdGF0ZS52YWx1ZSA9PT0gdGhpcy5zdGF0ZVZhbHVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnN0YXRlVmFsdWUgPSBuZXdTdGF0ZS52YWx1ZTtcclxuICAgIHRoaXMudmlld1ZhbHVlID0gdGhpcy5uZ3J4VmFsdWVDb252ZXJ0ZXIuY29udmVydFN0YXRlVG9WaWV3VmFsdWUobmV3U3RhdGUudmFsdWUpO1xyXG4gICAgdGhpcy52aWV3QWRhcHRlci5zZXRWaWV3VmFsdWUodGhpcy52aWV3VmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlVmlld0lmSXNEaXNhYmxlZENoYW5nZWQobmV3U3RhdGU6IEZvcm1Db250cm9sU3RhdGU8VFN0YXRlVmFsdWU+LCBvbGRTdGF0ZTogRm9ybUNvbnRyb2xTdGF0ZTxUU3RhdGVWYWx1ZT4gfCB1bmRlZmluZWQpIHtcclxuICAgIGlmICghdGhpcy52aWV3QWRhcHRlci5zZXRJc0Rpc2FibGVkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob2xkU3RhdGUgJiYgbmV3U3RhdGUuaXNEaXNhYmxlZCA9PT0gb2xkU3RhdGUuaXNEaXNhYmxlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy52aWV3QWRhcHRlci5zZXRJc0Rpc2FibGVkKG5ld1N0YXRlLmlzRGlzYWJsZWQpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlVmlld0lmSXNGb2N1c2VkQ2hhbmdlZChuZXdTdGF0ZTogRm9ybUNvbnRyb2xTdGF0ZTxUU3RhdGVWYWx1ZT4sIG9sZFN0YXRlOiBGb3JtQ29udHJvbFN0YXRlPFRTdGF0ZVZhbHVlPiB8IHVuZGVmaW5lZCkge1xyXG4gICAgaWYgKCF0aGlzLmZvY3VzVHJhY2tpbmdJc0VuYWJsZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChvbGRTdGF0ZSAmJiBuZXdTdGF0ZS5pc0ZvY3VzZWQgPT09IG9sZFN0YXRlLmlzRm9jdXNlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG5ld1N0YXRlLmlzRm9jdXNlZCkge1xyXG4gICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5ibHVyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZGlzcGF0Y2hBY3Rpb24oYWN0aW9uOiBBY3Rpb25zPFRTdGF0ZVZhbHVlPikge1xyXG4gICAgaWYgKHRoaXMuYWN0aW9uc1N1YmplY3QgIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5hY3Rpb25zU3ViamVjdC5uZXh0KGFjdGlvbik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FjdGlvbnNTdWJqZWN0IG11c3QgYmUgcHJlc2VudCBpbiBvcmRlciB0byBkaXNwYXRjaCBhY3Rpb25zIScpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBpZiAoIXRoaXMuc3RhdGUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgZm9ybSBzdGF0ZSBtdXN0IG5vdCBiZSB1bmRlZmluZWQhJyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTtcclxuXHJcbiAgICB0aGlzLnVwZGF0ZVZpZXdJZkNvbnRyb2xJZENoYW5nZWQodGhpcy5zdGF0ZSwgdW5kZWZpbmVkKTtcclxuICAgIHRoaXMudXBkYXRlVmlld0lmVmFsdWVDaGFuZ2VkKHRoaXMuc3RhdGUsIHVuZGVmaW5lZCk7XHJcbiAgICB0aGlzLnVwZGF0ZVZpZXdJZklzRGlzYWJsZWRDaGFuZ2VkKHRoaXMuc3RhdGUsIHVuZGVmaW5lZCk7XHJcbiAgICB0aGlzLnVwZGF0ZVZpZXdJZklzRm9jdXNlZENoYW5nZWQodGhpcy5zdGF0ZSwgdW5kZWZpbmVkKTtcclxuXHJcbiAgICBjb25zdCBkaXNwYXRjaE1hcmtBc0RpcnR5QWN0aW9uID0gKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5zdGF0ZS5pc1ByaXN0aW5lKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaEFjdGlvbihuZXcgTWFya0FzRGlydHlBY3Rpb24odGhpcy5zdGF0ZS5pZCkpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IGRpc3BhdGNoU2V0VmFsdWVBY3Rpb24gPSAoKSA9PiB7XHJcbiAgICAgIHRoaXMuc3RhdGVWYWx1ZSA9IHRoaXMubmdyeFZhbHVlQ29udmVydGVyLmNvbnZlcnRWaWV3VG9TdGF0ZVZhbHVlKHRoaXMudmlld1ZhbHVlKTtcclxuICAgICAgaWYgKHRoaXMuc3RhdGVWYWx1ZSAhPT0gdGhpcy5zdGF0ZS52YWx1ZSkge1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hBY3Rpb24obmV3IFNldFZhbHVlQWN0aW9uKHRoaXMuc3RhdGUuaWQsIHRoaXMuc3RhdGVWYWx1ZSkpO1xyXG5cclxuICAgICAgICBkaXNwYXRjaE1hcmtBc0RpcnR5QWN0aW9uKCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgdGhpcy52aWV3QWRhcHRlci5zZXRPbkNoYW5nZUNhbGxiYWNrKCh2aWV3VmFsdWU6IFRWaWV3VmFsdWUpID0+IHtcclxuICAgICAgdGhpcy52aWV3VmFsdWUgPSB2aWV3VmFsdWU7XHJcblxyXG4gICAgICBpZiAodGhpcy5uZ3J4VXBkYXRlT24gPT09IE5HUlhfVVBEQVRFX09OX1RZUEUuQ0hBTkdFKSB7XHJcbiAgICAgICAgZGlzcGF0Y2hTZXRWYWx1ZUFjdGlvbigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLnZpZXdBZGFwdGVyLnNldE9uVG91Y2hlZENhbGxiYWNrKCgpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLnN0YXRlLmlzVG91Y2hlZCAmJiB0aGlzLm5ncnhVcGRhdGVPbiAhPT0gTkdSWF9VUERBVEVfT05fVFlQRS5ORVZFUikge1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hBY3Rpb24obmV3IE1hcmtBc1RvdWNoZWRBY3Rpb24odGhpcy5zdGF0ZS5pZCkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAodGhpcy5uZ3J4VXBkYXRlT24gPT09IE5HUlhfVVBEQVRFX09OX1RZUEUuQkxVUikge1xyXG4gICAgICAgIGRpc3BhdGNoU2V0VmFsdWVBY3Rpb24oKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAvLyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgdmlldyBhZ2FpbiBhZnRlciBpdCB3YXMgaW5pdGlhbGl6ZWQgc2luY2Ugc29tZVxyXG4gICAgLy8gY29udHJvbHMgZGVwZW5kIG9uIGNoaWxkIGVsZW1lbnRzIGZvciBzZXR0aW5nIHRoZSB2YWx1ZSAoZS5nLiBzZWxlY3RzKVxyXG4gICAgdGhpcy52aWV3QWRhcHRlci5zZXRWaWV3VmFsdWUodGhpcy52aWV3VmFsdWUpO1xyXG4gICAgaWYgKHRoaXMudmlld0FkYXB0ZXIuc2V0SXNEaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLnZpZXdBZGFwdGVyLnNldElzRGlzYWJsZWQodGhpcy5zdGF0ZS5pc0Rpc2FibGVkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzaW4nKVxyXG4gIEBIb3N0TGlzdGVuZXIoJ2ZvY3Vzb3V0JylcclxuICBvbkZvY3VzQ2hhbmdlKCkge1xyXG4gICAgaWYgKCF0aGlzLmZvY3VzVHJhY2tpbmdJc0VuYWJsZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlzQ29udHJvbEZvY3VzZWQgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQgPT09IHRoaXMuZG9tIS5hY3RpdmVFbGVtZW50O1xyXG4gICAgaWYgKGlzQ29udHJvbEZvY3VzZWQgIT09IHRoaXMuc3RhdGUuaXNGb2N1c2VkKSB7XHJcbiAgICAgIHRoaXMuZGlzcGF0Y2hBY3Rpb24oaXNDb250cm9sRm9jdXNlZCA/IG5ldyBGb2N1c0FjdGlvbih0aGlzLnN0YXRlLmlkKSA6IG5ldyBVbmZvY3VzQWN0aW9uKHRoaXMuc3RhdGUuaWQpKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19