import * as tslib_1 from "tslib";
import { computeArrayState, isArrayState } from '../state';
import { ensureState } from './util';
function updateArrayControlsState(filterFn, updateFn) {
    return function (state) {
        var hasChanged = false;
        var newControls = state.controls.map(function (control, idx) {
            if (!filterFn(control, idx)) {
                return control;
            }
            var newControl = updateFn(control, state);
            hasChanged = hasChanged || newControl !== control;
            return newControl;
        });
        return hasChanged ? newControls : state.controls;
    };
}
function updateArraySingle(filterFn, updateFn) {
    return function (state) {
        var newControls = updateArrayControlsState(filterFn, updateFn)(state);
        return newControls !== state.controls
            ? computeArrayState(state.id, newControls, state.value, state.errors, state.pendingValidations, state.userDefinedProperties, {
                wasOrShouldBeDirty: state.isDirty,
                wasOrShouldBeEnabled: state.isEnabled,
                wasOrShouldBeTouched: state.isTouched,
                wasOrShouldBeSubmitted: state.isSubmitted,
            })
            : state;
    };
}
export function updateArrayWithFilter(stateOrFilterFunction, filterFunctionOrFunctionOrFunctionArray, updateFnOrUpdateFnArr) {
    var rest = [];
    for (var _i = 3; _i < arguments.length; _i++) {
        rest[_i - 3] = arguments[_i];
    }
    if (isArrayState(stateOrFilterFunction)) {
        var filterFn_1 = filterFunctionOrFunctionOrFunctionArray;
        var updateFnArr_1 = Array.isArray(updateFnOrUpdateFnArr) ? updateFnOrUpdateFnArr : [updateFnOrUpdateFnArr];
        return updateFnArr_1.concat.apply(updateFnArr_1, tslib_1.__spread(rest)).reduce(function (s, updateFn) { return updateArraySingle(filterFn_1, updateFn)(s); }, stateOrFilterFunction);
    }
    var updateFnArr = Array.isArray(filterFunctionOrFunctionOrFunctionArray)
        ? filterFunctionOrFunctionOrFunctionArray
        : [filterFunctionOrFunctionOrFunctionArray];
    updateFnArr = updateFnOrUpdateFnArr === undefined ? updateFnArr : updateFnArr.concat(updateFnOrUpdateFnArr);
    return function (s) { return updateArrayWithFilter(ensureState(s), stateOrFilterFunction, updateFnArr.concat(rest)); };
}
export function updateArray(stateOrFunctionOrFunctionArray, updateFnOrUpdateFnArr) {
    var rest = [];
    for (var _i = 2; _i < arguments.length; _i++) {
        rest[_i - 2] = arguments[_i];
    }
    if (isArrayState(stateOrFunctionOrFunctionArray)) {
        var updateFnArr_2 = Array.isArray(updateFnOrUpdateFnArr) ? updateFnOrUpdateFnArr : [updateFnOrUpdateFnArr];
        return updateFnArr_2.concat.apply(updateFnArr_2, tslib_1.__spread(rest)).reduce(function (s, updateFn) { return updateArraySingle(function () { return true; }, updateFn)(s); }, stateOrFunctionOrFunctionArray);
    }
    var updateFnArr = Array.isArray(stateOrFunctionOrFunctionArray) ? stateOrFunctionOrFunctionArray : [stateOrFunctionOrFunctionArray];
    updateFnArr = updateFnOrUpdateFnArr === undefined ? updateFnArr : updateFnArr.concat(updateFnOrUpdateFnArr);
    return function (s) { return updateArray(ensureState(s), updateFnArr.concat(rest)); };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLWFycmF5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmdyeC1mb3Jtcy8iLCJzb3VyY2VzIjpbInNyYy91cGRhdGUtZnVuY3Rpb24vdXBkYXRlLWFycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQTZCLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN0RixPQUFPLEVBQUUsV0FBVyxFQUFjLE1BQU0sUUFBUSxDQUFDO0FBSWpELFNBQVMsd0JBQXdCLENBQVMsUUFBMEIsRUFBRSxRQUErRDtJQUNuSSxPQUFPLFVBQUMsS0FBNkI7UUFDbkMsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQUMsT0FBTyxFQUFFLEdBQUc7WUFDbEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQzNCLE9BQU8sT0FBTyxDQUFDO2FBQ2hCO1lBRUQsSUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM1QyxVQUFVLEdBQUcsVUFBVSxJQUFJLFVBQVUsS0FBSyxPQUFPLENBQUM7WUFDbEQsT0FBTyxVQUFVLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFVBQVUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO0lBQ25ELENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFTLFFBQTBCLEVBQUUsUUFBK0Q7SUFDNUgsT0FBTyxVQUFDLEtBQTZCO1FBQ25DLElBQU0sV0FBVyxHQUFHLHdCQUF3QixDQUFTLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNoRixPQUFPLFdBQVcsS0FBSyxLQUFLLENBQUMsUUFBUTtZQUNuQyxDQUFD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V0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDNUcsT0FBTyxVQUFDLENBQXlCLElBQUssT0FBQSxXQUFXLENBQVMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBN0QsQ0FBNkQsQ0FBQztBQUN0RyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29tcHV0ZUFycmF5U3RhdGUsIEZvcm1BcnJheVN0YXRlLCBGb3JtU3RhdGUsIGlzQXJyYXlTdGF0ZSB9IGZyb20gJy4uL3N0YXRlJztcclxuaW1wb3J0IHsgZW5zdXJlU3RhdGUsIFByb2plY3RGbjIgfSBmcm9tICcuL3V0aWwnO1xyXG5cclxuZXhwb3J0IHR5cGUgRmlsdGVyRm48VFZhbHVlPiA9IChzOiBGb3JtU3RhdGU8VFZhbHVlPiwgaWR4OiBudW1iZXIpID0+IGJvb2xlYW47XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVBcnJheUNvbnRyb2xzU3RhdGU8VFZhbHVlPihmaWx0ZXJGbjogRmlsdGVyRm48VFZhbHVlPiwgdXBkYXRlRm46IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+KSB7XHJcbiAgcmV0dXJuIChzdGF0ZTogRm9ybUFycmF5U3RhdGU8VFZhbHVlPikgPT4ge1xyXG4gICAgbGV0IGhhc0NoYW5nZWQgPSBmYWxzZTtcclxuICAgIGNvbnN0IG5ld0NvbnRyb2xzID0gc3RhdGUuY29udHJvbHMubWFwKChjb250cm9sLCBpZHgpID0+IHtcclxuICAgICAgaWYgKCFmaWx0ZXJGbihjb250cm9sLCBpZHgpKSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbnRyb2w7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IG5ld0NvbnRyb2wgPSB1cGRhdGVGbihjb250cm9sLCBzdGF0ZSk7XHJcbiAgICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IG5ld0NvbnRyb2wgIT09IGNvbnRyb2w7XHJcbiAgICAgIHJldHVybiBuZXdDb250cm9sO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gaGFzQ2hhbmdlZCA/IG5ld0NvbnRyb2xzIDogc3RhdGUuY29udHJvbHM7XHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlQXJyYXlTaW5nbGU8VFZhbHVlPihmaWx0ZXJGbjogRmlsdGVyRm48VFZhbHVlPiwgdXBkYXRlRm46IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+KSB7XHJcbiAgcmV0dXJuIChzdGF0ZTogRm9ybUFycmF5U3RhdGU8VFZhbHVlPik6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4gPT4ge1xyXG4gICAgY29uc3QgbmV3Q29udHJvbHMgPSB1cGRhdGVBcnJheUNvbnRyb2xzU3RhdGU8VFZhbHVlPihmaWx0ZXJGbiwgdXBkYXRlRm4pKHN0YXRlKTtcclxuICAgIHJldHVybiBuZXdDb250cm9scyAhPT0gc3RhdGUuY29udHJvbHNcclxuICAgICAgPyBjb21wdXRlQXJyYXlTdGF0ZTxUVmFsdWU+KFxyXG4gICAgICAgIHN0YXRlLmlkLFxyXG4gICAgICAgIG5ld0NvbnRyb2xzLFxyXG4gICAgICAgIHN0YXRlLnZhbHVlLFxyXG4gICAgICAgIHN0YXRlLmVycm9ycyxcclxuICAgICAgICBzdGF0ZS5wZW5kaW5nVmFsaWRhdGlvbnMsXHJcbiAgICAgICAgc3RhdGUudXNlckRlZmluZWRQcm9wZXJ0aWVzLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHdhc09yU2hvdWxkQmVEaXJ0eTogc3RhdGUuaXNEaXJ0eSxcclxuICAgICAgICAgIHdhc09yU2hvdWxkQmVFbmFibGVkOiBzdGF0ZS5pc0VuYWJsZWQsXHJcbiAgICAgICAgICB3YXNPclNob3VsZEJlVG91Y2hlZDogc3RhdGUuaXNUb3VjaGVkLFxyXG4gICAgICAgICAgd2FzT3JTaG91bGRCZVN1Ym1pdHRlZDogc3RhdGUuaXNTdWJtaXR0ZWQsXHJcbiAgICAgICAgfSxcclxuICAgICAgKVxyXG4gICAgICA6IHN0YXRlO1xyXG4gIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUaGlzIHVwZGF0ZSBmdW5jdGlvbiB0YWtlcyBhIGZpbHRlciBmdW5jdGlvbiBhbmQgb25lIG9yIG1vcmUgdXBkYXRlIGZ1bmN0aW9uc1xyXG4gKiBhbmQgcmV0dXJucyBhIHByb2plY3Rpb24gZnVuY3Rpb24gdGhhdCBhcHBsaWVzIGFsbCB1cGRhdGUgZnVuY3Rpb25zIG9uZSBhZnRlclxyXG4gKiBhbm90aGVyIHRvIGVhY2ggZWxlbWVudCBvZiB0aGUgZm9ybSBhcnJheSBzdGF0ZSBmb3Igd2hpY2ggdGhlIGZpbHRlciBmdW5jdGlvblxyXG4gKiByZXR1cm5zIGB0cnVlYC5cclxuICpcclxuICogVGhlIGZvbGxvd2luZyAoY29udHJpdmVkKSBleGFtcGxlIHVzZXMgdGhpcyBmdW5jdGlvbiB0byB2YWxpZGF0ZSBhbGwgaXRzXHJcbiAqIGNoaWxkcmVuIHRvIGJlIHJlcXVpcmVkIGFuZCBtYXJrIHRoZW0gYXMgZGlydHkuXHJcbiAqXHJcbmBgYHR5cGVzY3JpcHRcclxuY29uc3QgYXJyYXlVcGRhdGVGbiA9IHVwZGF0ZUFycmF5PHN0cmluZz4oXHJcbiAgKF8sIGlkeCkgPT4gaWR4ID4gMCxcclxuICB2YWxpZGF0ZShyZXF1aXJlZCksXHJcbiAgbWFya0FzRGlydHksXHJcbik7XHJcbmNvbnN0IHVwZGF0ZWRTdGF0ZSA9IGFycmF5VXBkYXRlRm4oc3RhdGUpO1xyXG5gYGBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVBcnJheVdpdGhGaWx0ZXI8VFZhbHVlPihcclxuICBmaWx0ZXJGbjogRmlsdGVyRm48VFZhbHVlPixcclxuICB1cGRhdGVGbjogUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj4sXHJcbiAgLi4udXBkYXRlRm5BcnI6IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+W11cclxuKTogKHN0YXRlOiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+KSA9PiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+O1xyXG5cclxuLyoqXHJcbiAqIFRoaXMgdXBkYXRlIGZ1bmN0aW9uIHRha2VzIGEgZmlsdGVyIGZ1bmN0aW9uIGFuZCBhbiBhcnJheSBvZiB1cGRhdGUgZnVuY3Rpb25zXHJcbiAqIGFuZCByZXR1cm5zIGEgcHJvamVjdGlvbiBmdW5jdGlvbiB0aGF0IGFwcGxpZXMgYWxsIHVwZGF0ZSBmdW5jdGlvbnMgb25lIGFmdGVyXHJcbiAqIGFub3RoZXIgdG8gZWFjaCBlbGVtZW50IG9mIHRoZSBmb3JtIGFycmF5IHN0YXRlIGZvciB3aGljaCB0aGUgZmlsdGVyIGZ1bmN0aW9uXHJcbiAqIHJldHVybnMgYHRydWVgLlxyXG4gKlxyXG4gKiBUaGUgZm9sbG93aW5nIChjb250cml2ZWQpIGV4YW1wbGUgdXNlcyB0aGlzIGZ1bmN0aW9uIHRvIHZhbGlkYXRlIGFsbCBpdHNcclxuICogY2hpbGRyZW4gdG8gYmUgcmVxdWlyZWQgYW5kIG1hcmsgdGhlbSBhcyBkaXJ0eS5cclxuICpcclxuYGBgdHlwZXNjcmlwdFxyXG5jb25zdCBhcnJheVVwZGF0ZUZuID0gdXBkYXRlQXJyYXk8c3RyaW5nPihcclxuICAoXywgaWR4KSA9PiBpZHggPiAwLFxyXG4gIFtcclxuICAgIHZhbGlkYXRlKHJlcXVpcmVkKSxcclxuICAgIG1hcmtBc0RpcnR5LFxyXG4gIF0sXHJcbik7XHJcbmNvbnN0IHVwZGF0ZWRTdGF0ZSA9IGFycmF5VXBkYXRlRm4oc3RhdGUpO1xyXG5gYGBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVBcnJheVdpdGhGaWx0ZXI8VFZhbHVlPihcclxuICBmaWx0ZXJGbjogRmlsdGVyRm48VFZhbHVlPixcclxuICB1cGRhdGVGbkFycjogUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5bXSxcclxuKTogKHN0YXRlOiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+KSA9PiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+O1xyXG5cclxuLyoqXHJcbiAqIFRoaXMgdXBkYXRlIGZ1bmN0aW9uIHRha2VzIGEgZm9ybSBhcnJheSBzdGF0ZSwgYSBmaWx0ZXIgZnVuY3Rpb24sIGFuZCBhIHZhcmlhYmxlXHJcbiAqIG51bWJlciBvZiB1cGRhdGUgZnVuY3Rpb25zIGFuZCBhcHBsaWVzIGFsbCB1cGRhdGUgZnVuY3Rpb25zIG9uZSBhZnRlciBhbm90aGVyIHRvXHJcbiAqIGVhY2ggZWxlbWVudCBvZiB0aGUgZm9ybSBhcnJheSBzdGF0ZSBmb3Igd2hpY2ggdGhlIGZpbHRlciBmdW5jdGlvbiByZXR1cm5zIGB0cnVlYC5cclxuICpcclxuICogVGhlIGZvbGxvd2luZyAoY29udHJpdmVkKSBleGFtcGxlIHVzZXMgdGhpcyBmdW5jdGlvbiB0byB2YWxpZGF0ZSBhbGwgaXRzXHJcbiAqIGNoaWxkcmVuIHRvIGJlIHJlcXVpcmVkIGFuZCBtYXJrIHRoZW0gYXMgZGlydHkuXHJcbiAqXHJcbmBgYHR5cGVzY3JpcHRcclxuY29uc3QgdXBkYXRlZFN0YXRlID0gdXBkYXRlQXJyYXk8c3RyaW5nPihcclxuICBzdGF0ZSxcclxuICAoXywgaWR4KSA9PiBpZHggPiAwLFxyXG4gIHZhbGlkYXRlKHJlcXVpcmVkKSxcclxuICBtYXJrQXNEaXJ0eSxcclxuKTtcclxuYGBgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJyYXlXaXRoRmlsdGVyPFRWYWx1ZT4oXHJcbiAgc3RhdGU6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4sXHJcbiAgZmlsdGVyRm46IEZpbHRlckZuPFRWYWx1ZT4sXHJcbiAgdXBkYXRlRm46IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+LFxyXG4gIC4uLnVwZGF0ZUZuQXJyOiBQcm9qZWN0Rm4yPEZvcm1TdGF0ZTxUVmFsdWU+LCBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+PltdXHJcbik6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT47XHJcblxyXG4vKipcclxuICogVGhpcyB1cGRhdGUgZnVuY3Rpb24gdGFrZXMgYSBmb3JtIGFycmF5IHN0YXRlLCBhIGZpbHRlciBmdW5jdGlvbiwgYW5kIGFuIGFycmF5IG9mXHJcbiAqIHVwZGF0ZSBmdW5jdGlvbnMgYW5kIGFwcGxpZXMgYWxsIHVwZGF0ZSBmdW5jdGlvbnMgb25lIGFmdGVyIGFub3RoZXIgdG8gZWFjaFxyXG4gKiBlbGVtZW50IG9mIHRoZSBmb3JtIGFycmF5IHN0YXRlIGZvciB3aGljaCB0aGUgZmlsdGVyIGZ1bmN0aW9uIHJldHVybnMgYHRydWVgLlxyXG4gKlxyXG4gKiBUaGUgZm9sbG93aW5nIChjb250cml2ZWQpIGV4YW1wbGUgdXNlcyB0aGlzIGZ1bmN0aW9uIHRvIHZhbGlkYXRlIGFsbCBpdHNcclxuICogY2hpbGRyZW4gdG8gYmUgcmVxdWlyZWQgYW5kIG1hcmsgdGhlbSBhcyBkaXJ0eS5cclxuICpcclxuYGBgdHlwZXNjcmlwdFxyXG5jb25zdCB1cGRhdGVkU3RhdGUgPSB1cGRhdGVBcnJheTxzdHJpbmc+KFxyXG4gIHN0YXRlLFxyXG4gIChfLCBpZHgpID0+IGlkeCA+IDAsXHJcbiAgW1xyXG4gICAgdmFsaWRhdGUocmVxdWlyZWQpLFxyXG4gICAgbWFya0FzRGlydHksXHJcbiAgXSxcclxuKTtcclxuYGBgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJyYXlXaXRoRmlsdGVyPFRWYWx1ZT4oXHJcbiAgc3RhdGU6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4sXHJcbiAgZmlsdGVyRm46IEZpbHRlckZuPFRWYWx1ZT4sXHJcbiAgdXBkYXRlRm5BcnI6IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+W10sXHJcbik6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT47XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJyYXlXaXRoRmlsdGVyPFRWYWx1ZT4oXHJcbiAgc3RhdGVPckZpbHRlckZ1bmN0aW9uOiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+IHwgRmlsdGVyRm48VFZhbHVlPixcclxuICBmaWx0ZXJGdW5jdGlvbk9yRnVuY3Rpb25PckZ1bmN0aW9uQXJyYXk6XHJcbiAgICB8IEZpbHRlckZuPFRWYWx1ZT5cclxuICAgIHwgUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5cclxuICAgIHwgUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5bXSxcclxuICB1cGRhdGVGbk9yVXBkYXRlRm5BcnI/OiBQcm9qZWN0Rm4yPEZvcm1TdGF0ZTxUVmFsdWU+LCBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+PiB8IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+W10sXHJcbiAgLi4ucmVzdDogUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5bXVxyXG4pIHtcclxuICBpZiAoaXNBcnJheVN0YXRlPFRWYWx1ZT4oc3RhdGVPckZpbHRlckZ1bmN0aW9uKSkge1xyXG4gICAgY29uc3QgZmlsdGVyRm4gPSBmaWx0ZXJGdW5jdGlvbk9yRnVuY3Rpb25PckZ1bmN0aW9uQXJyYXkgYXMgRmlsdGVyRm48VFZhbHVlPjtcclxuICAgIGNvbnN0IHVwZGF0ZUZuQXJyID0gQXJyYXkuaXNBcnJheSh1cGRhdGVGbk9yVXBkYXRlRm5BcnIpID8gdXBkYXRlRm5PclVwZGF0ZUZuQXJyIDogW3VwZGF0ZUZuT3JVcGRhdGVGbkFyciFdO1xyXG4gICAgcmV0dXJuIHVwZGF0ZUZuQXJyLmNvbmNhdCguLi5yZXN0KS5yZWR1Y2UoKHMsIHVwZGF0ZUZuKSA9PiB1cGRhdGVBcnJheVNpbmdsZTxUVmFsdWU+KGZpbHRlckZuLCB1cGRhdGVGbikocyksIHN0YXRlT3JGaWx0ZXJGdW5jdGlvbik7XHJcbiAgfVxyXG5cclxuICBsZXQgdXBkYXRlRm5BcnIgPSBBcnJheS5pc0FycmF5KGZpbHRlckZ1bmN0aW9uT3JGdW5jdGlvbk9yRnVuY3Rpb25BcnJheSlcclxuICAgID8gZmlsdGVyRnVuY3Rpb25PckZ1bmN0aW9uT3JGdW5jdGlvbkFycmF5XHJcbiAgICA6IFtmaWx0ZXJGdW5jdGlvbk9yRnVuY3Rpb25PckZ1bmN0aW9uQXJyYXkgYXMgUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5dO1xyXG4gIHVwZGF0ZUZuQXJyID0gdXBkYXRlRm5PclVwZGF0ZUZuQXJyID09PSB1bmRlZmluZWQgPyB1cGRhdGVGbkFyciA6IHVwZGF0ZUZuQXJyLmNvbmNhdCh1cGRhdGVGbk9yVXBkYXRlRm5BcnIpO1xyXG4gIHJldHVybiAoczogRm9ybUFycmF5U3RhdGU8VFZhbHVlPikgPT4gdXBkYXRlQXJyYXlXaXRoRmlsdGVyPFRWYWx1ZT4oZW5zdXJlU3RhdGUocyksIHN0YXRlT3JGaWx0ZXJGdW5jdGlvbiwgdXBkYXRlRm5BcnIuY29uY2F0KHJlc3QpKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRoaXMgdXBkYXRlIGZ1bmN0aW9uIHRha2VzIG9uZSBvciBtb3JlIHVwZGF0ZSBmdW5jdGlvbnMgYW5kIHJldHVybnMgYVxyXG4gKiBwcm9qZWN0aW9uIGZ1bmN0aW9uIHRoYXQgYXBwbGllcyBhbGwgdXBkYXRlIGZ1bmN0aW9ucyBvbmUgYWZ0ZXIgYW5vdGhlciB0b1xyXG4gKiBlYWNoIGVsZW1lbnQgb2YgdGhlIGZvcm0gYXJyYXkgc3RhdGUuXHJcbiAqXHJcbiAqIFRoZSBmb2xsb3dpbmcgKGNvbnRyaXZlZCkgZXhhbXBsZSB1c2VzIHRoaXMgZnVuY3Rpb24gdG8gdmFsaWRhdGUgYWxsIGl0c1xyXG4gKiBjaGlsZHJlbiB0byBiZSByZXF1aXJlZCBhbmQgbWFyayB0aGVtIGFzIGRpcnR5LlxyXG4gKlxyXG5gYGB0eXBlc2NyaXB0XHJcbmNvbnN0IGFycmF5VXBkYXRlRm4gPSB1cGRhdGVBcnJheTxzdHJpbmc+KFxyXG4gIHZhbGlkYXRlPHN0cmluZz4ocmVxdWlyZWQpLFxyXG4gIG1hcmtBc0RpcnR5LFxyXG4pO1xyXG5jb25zdCB1cGRhdGVkU3RhdGUgPSBhcnJheVVwZGF0ZUZuKHN0YXRlKTtcclxuYGBgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJyYXk8VFZhbHVlPihcclxuICB1cGRhdGVGbjogUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj4sXHJcbiAgLi4udXBkYXRlRm5BcnI6IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+W11cclxuKTogKHN0YXRlOiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+KSA9PiBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+O1xyXG5cclxuLyoqXHJcbiAqIFRoaXMgdXBkYXRlIGZ1bmN0aW9uIHRha2VzIGFuIGFycmF5IG9mIHVwZGF0ZSBmdW5jdGlvbnMgYW5kIHJldHVybnNcclxuICogYSBwcm9qZWN0aW9uIGZ1bmN0aW9uIHRoYXQgYXBwbGllcyBhbGwgdXBkYXRlIGZ1bmN0aW9ucyBvbmUgYWZ0ZXIgYW5vdGhlciB0b1xyXG4gKiBlYWNoIGVsZW1lbnQgb2YgdGhlIGZvcm0gYXJyYXkgc3RhdGUuXHJcbiAqXHJcbiAqIFRoZSBmb2xsb3dpbmcgKGNvbnRyaXZlZCkgZXhhbXBsZSB1c2VzIHRoaXMgZnVuY3Rpb24gdG8gdmFsaWRhdGUgYWxsIGl0c1xyXG4gKiBjaGlsZHJlbiB0byBiZSByZXF1aXJlZCBhbmQgbWFyayB0aGVtIGFzIGRpcnR5LlxyXG4gKlxyXG5gYGB0eXBlc2NyaXB0XHJcbmNvbnN0IGFycmF5VXBkYXRlRm4gPSB1cGRhdGVBcnJheTxzdHJpbmc+KFtcclxuICB2YWxpZGF0ZTxzdHJpbmc+KHJlcXVpcmVkKSxcclxuICBtYXJrQXNEaXJ0eSxcclxuXSk7XHJcbmNvbnN0IHVwZGF0ZWRTdGF0ZSA9IGFycmF5VXBkYXRlRm4oc3RhdGUpO1xyXG5gYGBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVBcnJheTxUVmFsdWU+KFxyXG4gIHVwZGF0ZUZuQXJyOiBQcm9qZWN0Rm4yPEZvcm1TdGF0ZTxUVmFsdWU+LCBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+PltdLFxyXG4pOiAoc3RhdGU6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4pID0+IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT47XHJcblxyXG4vKipcclxuICogVGhpcyB1cGRhdGUgZnVuY3Rpb24gdGFrZXMgYSBmb3JtIGFycmF5IHN0YXRlIGFuZCBvbmUgb3IgbW9yZSB1cGRhdGUgZnVuY3Rpb25zXHJcbiAqIGFuZCBhcHBsaWVzIGFsbCB1cGRhdGUgZnVuY3Rpb25zIG9uZSBhZnRlciBhbm90aGVyIHRvIGVhY2ggZWxlbWVudCBvZiB0aGUgZm9ybVxyXG4gKiBhcnJheSBzdGF0ZS5cclxuICpcclxuICogVGhlIGZvbGxvd2luZyAoY29udHJpdmVkKSBleGFtcGxlIHVzZXMgdGhpcyBmdW5jdGlvbiB0byB2YWxpZGF0ZSBhbGwgaXRzXHJcbiAqIGNoaWxkcmVuIHRvIGJlIHJlcXVpcmVkIGFuZCBtYXJrIHRoZW0gYXMgZGlydHkuXHJcbiAqXHJcbmBgYHR5cGVzY3JpcHRcclxuY29uc3QgdXBkYXRlZFN0YXRlID0gdXBkYXRlQXJyYXk8c3RyaW5nPihcclxuICBzdGF0ZSxcclxuICB2YWxpZGF0ZTxzdHJpbmc+KHJlcXVpcmVkKSxcclxuICBtYXJrQXNEaXJ0eSxcclxuKTtcclxuYGBgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJyYXk8VFZhbHVlPihcclxuICBzdGF0ZTogRm9ybUFycmF5U3RhdGU8VFZhbHVlPixcclxuICB1cGRhdGVGbjogUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj4sXHJcbiAgLi4udXBkYXRlRm5BcnI6IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+W11cclxuKTogRm9ybUFycmF5U3RhdGU8VFZhbHVlPjtcclxuXHJcbi8qKlxyXG4gKiBUaGlzIHVwZGF0ZSBmdW5jdGlvbiB0YWtlcyBhIGZvcm0gYXJyYXkgc3RhdGUgYW5kIGFuIGFycmF5IG9mIHVwZGF0ZVxyXG4gKiBmdW5jdGlvbnMgYW5kIGFwcGxpZXMgYWxsIHVwZGF0ZSBmdW5jdGlvbnMgb25lIGFmdGVyIGFub3RoZXIgdG8gZWFjaCBlbGVtZW50XHJcbiAqIG9mIHRoZSBmb3JtIGFycmF5IHN0YXRlLlxyXG4gKlxyXG4gKiBUaGUgZm9sbG93aW5nIChjb250cml2ZWQpIGV4YW1wbGUgdXNlcyB0aGlzIGZ1bmN0aW9uIHRvIHZhbGlkYXRlIGFsbCBpdHNcclxuICogY2hpbGRyZW4gdG8gYmUgcmVxdWlyZWQgYW5kIG1hcmsgdGhlbSBhcyBkaXJ0eS5cclxuICpcclxuYGBgdHlwZXNjcmlwdFxyXG5jb25zdCB1cGRhdGVkU3RhdGUgPSB1cGRhdGVBcnJheTxzdHJpbmc+KFxyXG4gIHN0YXRlLFxyXG4gIFtcclxuICAgIHZhbGlkYXRlPHN0cmluZz4ocmVxdWlyZWQpLFxyXG4gICAgbWFya0FzRGlydHksXHJcbiAgXSxcclxuKTtcclxuYGBgXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlQXJyYXk8VFZhbHVlPihcclxuICBzdGF0ZTogRm9ybUFycmF5U3RhdGU8VFZhbHVlPixcclxuICB1cGRhdGVGbkFycjogUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5bXSxcclxuKTogRm9ybUFycmF5U3RhdGU8VFZhbHVlPjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVBcnJheTxUVmFsdWU+KFxyXG4gIHN0YXRlT3JGdW5jdGlvbk9yRnVuY3Rpb25BcnJheTpcclxuICAgIHwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPlxyXG4gICAgfCBQcm9qZWN0Rm4yPEZvcm1TdGF0ZTxUVmFsdWU+LCBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+PlxyXG4gICAgfCBQcm9qZWN0Rm4yPEZvcm1TdGF0ZTxUVmFsdWU+LCBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+PltdLFxyXG4gIHVwZGF0ZUZuT3JVcGRhdGVGbkFycj86IFByb2plY3RGbjI8Rm9ybVN0YXRlPFRWYWx1ZT4sIEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4+IHwgUHJvamVjdEZuMjxGb3JtU3RhdGU8VFZhbHVlPiwgRm9ybUFycmF5U3RhdGU8VFZhbHVlPj5bXSxcclxuICAuLi5yZXN0OiBQcm9qZWN0Rm4yPEZvcm1TdGF0ZTxUVmFsdWU+LCBGb3JtQXJyYXlTdGF0ZTxUVmFsdWU+PltdXHJcbikge1xyXG4gIGlmIChpc0FycmF5U3RhdGU8VFZhbHVlPihzdGF0ZU9yRnVuY3Rpb25PckZ1bmN0aW9uQXJyYXkpKSB7XHJcbiAgICBjb25zdCB1cGRhdGVGbkFyciA9IEFycmF5LmlzQXJyYXkodXBkYXRlRm5PclVwZGF0ZUZuQXJyKSA/IHVwZGF0ZUZuT3JVcGRhdGVGbkFyciA6IFt1cGRhdGVGbk9yVXBkYXRlRm5BcnIhXTtcclxuICAgIHJldHVybiB1cGRhdGVGbkFyci5jb25jYXQoLi4ucmVzdCkucmVkdWNlKChzLCB1cGRhdGVGbikgPT4gdXBkYXRlQXJyYXlTaW5nbGU8VFZhbHVlPigoKSA9PiB0cnVlLCB1cGRhdGVGbikocyksIHN0YXRlT3JGdW5jdGlvbk9yRnVuY3Rpb25BcnJheSk7XHJcbiAgfVxyXG5cclxuICBsZXQgdXBkYXRlRm5BcnIgPSBBcnJheS5pc0FycmF5KHN0YXRlT3JGdW5jdGlvbk9yRnVuY3Rpb25BcnJheSkgPyBzdGF0ZU9yRnVuY3Rpb25PckZ1bmN0aW9uQXJyYXkgOiBbc3RhdGVPckZ1bmN0aW9uT3JGdW5jdGlvbkFycmF5XTtcclxuICB1cGRhdGVGbkFyciA9IHVwZGF0ZUZuT3JVcGRhdGVGbkFyciA9PT0gdW5kZWZpbmVkID8gdXBkYXRlRm5BcnIgOiB1cGRhdGVGbkFyci5jb25jYXQodXBkYXRlRm5PclVwZGF0ZUZuQXJyKTtcclxuICByZXR1cm4gKHM6IEZvcm1BcnJheVN0YXRlPFRWYWx1ZT4pID0+IHVwZGF0ZUFycmF5PFRWYWx1ZT4oZW5zdXJlU3RhdGUocyksIHVwZGF0ZUZuQXJyLmNvbmNhdChyZXN0KSk7XHJcbn1cclxuIl19